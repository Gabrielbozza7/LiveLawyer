# Supabase Information

Supabase is the backend database solution that we used to store user data as well as call recordings and their metadata. 

## Utilizing Supabase
1. Create an account for supabase, if you haven't already.
2. Request access to the project.
After receiving access, you should be able to see everything in the database, most importantly the tables and the bucket storage (call recordings).

## Environment Variables
### `LiveLawyerApp/.env`
1. On the Supabase project dashboard, click on the `Connect` button in the top.
2. Navigate to `Mobile Frameworks`, and set the framework to `Expo React Native`.
3. Copy the `EXPO_PUBLIC_SUPABASE_URL` and the `EXPO_PUBLIC_ANON_KEY` lines into the `LiveLawyerApp/.env` file.

Example:
```env
EXPO_PUBLIC_SUPABASE_URL=abc123
EXPO_PUBLIC_ANON_KEY=abc123
```

### `LiveLawyerBackend/.env`
1. On the Supabase project dashboard, navigate to `Project Settings`. Then go to `Data API`.
2. In the `.env` file, set `SUPABASE_URL` to the `Project URL` given.
3. In the `.env` file, set `SUPABASE_KEY` to the `[anon][public]` key given.
4. Navigate to the header on the Supabase Dashboard and click `Connect`.
5. Then click on ORMS and make sure you are seeing the Prisma Credentials.
6. In the `.env` file, set `DATABASE_URL` to the `DATABASE_URL` given.
7. In the `.env` file, set `DIRECT_URL` to the `DIRECT_URL` given.

*NOTE: The Prisma URL variables will likely follow the structure: `postgresql://postgres...`, however, you want to change it to `postgresql://prisma...`. We noticed that what Supabase provides seems to mess up and not allow the connection to formulate*

The backend currently requires an account to access the database for uploading recordings. At this time, an account should be created exclusively for the backend to upload
4. In the `.env` file, set `DATABASE_USER` to the backend account email address.
5. In the `.env` file, set `DATABASE_PASSWORD` to the backend account password.

Example:
```env
SUPABASE_URL=abc123
SUPABASE_KEY=abc123
DIRECT_URL=postgres://prisma...
DATABASE_URL=postgres://prisma...
DATABASE_USER=abc123
DATABASE_PASSWORD=abc123
```

## Table Breakdown
### User
Stores user information.
| Table Column | Description | Data Type |
| - | - | - |
| id | Unique identifier for each user | uuid (primary key) |
| lastName | Last name of the user | text |
| firstName | First name of the user | text |
| profPicUrl | Link to user's profile picture | text |
| phoneNum | Phone number of the user | text |
| email | Email of the user | text |
| userType | Type of user | UserType (Paralegal, Lawyer, Civilian, Dev) |
| sessionToken | Stores the session token of the user | text |
| dateJoined | Date that the user created their account | timestamp |

### Lawyer
Stores lawyer information.
| Table Column | Description | Data Type |
| - | - | - |
| id | Unique identifier for each lawyer/law office | uuid (primary key) |
| name | Name of the lawyer/law office | text |
| description | Description of the lawyer/law office | text |
| address | Address of the lawyer/law office | text |
| phoneNum | Phone number of the lawyer/law office | text |
| picUrl | Link to the picture set by the lawyer/law office | text |

### Contact
Keeps each contact for every user.
| Table Column | Description | Data Type |
| - | - | - |
| id | Unique identifier for each contact | uuid (primary key) |
| userId | The id of the user who stores this contact | uuid |
| lastName | Last name of the contact | text |
| firstName | First name of the contact | text |
| picUrl | Link to the picture of the contact set by the user | text |
| phoneNum | Phone number of the contact | text |
| email | Email of the contact | text |
| type | Type of contact | UserType (Paralegal, Lawyer, Civilian, Dev) |

### CallMetadata
Stores the metadata for each call.
| Table Column | Description | Data Type |
| - | - | - |
| id | Unique identifier for each call | uuid  |
| clientId | Unique identifier of the client that started the call | uuid |
| observerId | Unique identifier of the observer who answered the call | uuid |
| lawyerId | Unique identifier of the lawyer who was pulled into the call | uuid |
| twilioRoomSid | Identifier of the room generated by Twilio | varchar |
| startTime | Time the call was started | timestamp |

### CallRecording
Stores the recording reference information for each call.
| Table Column | Description | Data Type |
| - | - | - |
| callId | Unique identifier of the call | uuid | Foreign key referencing CallMetadata.id |
| userId | Unique identifier of the user who generated the recording | uuid |
| startTime | Time when the recording started | timestamp |
| trackType | Type of file of the recording (audio or video) | TrackType (Audio/Video) |
| s3Ref | Reference to the recording in bucket storage | varchar |

### CallEvent
Stores each event that happens in calls. This covers things like when a user joins and leaves, and when a lawyer is pulled in, etc.
| Table Column | Description | Data Type |
| - | - | - |
| callId | Unique identifier of the call | uuid | Foreign key referencing CallMetadata.id |
| userId | Unique identifier of the user who caused the event | uuid |
| action | What event occured | Action (Ended Call, Token Issued, Connected, Disconnected) |
| timestamp | Time of when the event occured | timestamp |

## Bucket Storage
We are utilizing Supabase's bucket storage to store audio and video recordings from the users of the app. The recording is handled by Twilio. When the call ends, the videos are downloaded to the backend server from Twilio and then uploaded to the `call-recordings` bucket from the backend server. Recordings are deleted from Twilio and the backend server upon successful upload to the bucket. 
`Twilio`-->`Backend Server`-->`call-recordings`
Audio and video files are stored in a folder titled the name of the Twilio room SID. Each file in this folder is named using the Twilio user SID, followed by the associated file format. 
Example: If the Twilio room SID was `TwiRoomSid`, the user SID was `TwiUserSid` and the file format was `.mp4`, the full path from the root would be `TwiRoomSid/TwiUserSid.mp4`.

## Important notes
* Supabase is a BaaS that helps us with bucket storage and also database activitites alongside authentication.
* We also have Prisma ORM setup to help integrate postgres easier.
    * Currently Prisma is not super useful but it was done as a way to ease into GraphQL in case the team decides to migrate.
    * Also, Prisma currently is bugged due to us utilizing the auth workflow from Supabase that utilizes two different types of database schemas.
    * Backend server has routes that would allow for easier data pulling, however, for sensitive data such as users profiles, it was better to use a Supabase client and change row level security policies.

## Running the Server
* CD into LiveLawyerBackend Directory 
* Run 'npm install' to ensure all backend dependencies are installed
* Run 'npx prisma db pull' to pull all database schema changes to the prisma file
* Run 'npx prisma generate' to generate a prisma client on the machine
* Finally, run 'npm start' to get the backend server running after you have the right .env file for the backend
